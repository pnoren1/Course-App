# מדריך הגדרת מערכת המייל

## סקירה כללית

המערכת כוללת שליחת מיילים מעוצבים אוטומטית למשתמשים חדשים כאשר הם נוספים למערכת. המיילים נשלחים הן במצב יצירה ישירה והן במצב הזמנה.

## תכונות המערכת

### 1. מיילים מעוצבים
- תבנית HTML מעוצבת בעברית (RTL)
- עיצוב רספונסיבי לנייד ושולחן עבודה
- צבעים ואיקונים מותאמים
- מידע מפורט על החשבון החדש

### 2. תוכן המייל כולל:
- ברכת ברוכים הבאים אישית
- פרטי החשבון (מייל, שם, תפקיד, ארגון, קבוצה)
- סיסמה זמנית (במצב יצירה ישירה)
- קישור להתחברות/השלמת הרשמה
- טיפים לשימוש במערכת
- הנחיות אבטחה

### 3. שני מצבי שליחה:
- **יצירה ישירה**: מייל עם סיסמה זמנית וקישור ישיר להתחברות
- **הזמנה**: מייל עם קישור להשלמת הרשמה

## הגדרת משתני הסביבה

הוסף את המשתנים הבאים לקובץ `.env.local`:

```env
# Email Configuration
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-app-password

# כתובת האתר לקישורים במייל
NEXT_PUBLIC_SITE_URL=http://localhost:3000
```

## הגדרה עבור Gmail

### 1. הפעלת אימות דו-שלבי
1. עבור להגדרות החשבון ב-Google
2. בחר "אבטחה" > "אימות דו-שלבי"
3. הפעל אימות דו-שלבי

### 2. יצירת סיסמת אפליקציה
1. עבור להגדרות החשבון ב-Google
2. בחר "אבטחה" > "סיסמאות אפליקציות"
3. צור סיסמת אפליקציה חדשה
4. השתמש בסיסמה זו במשתנה `EMAIL_PASS`

### 3. הגדרת משתני הסביבה
```env
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=your-gmail@gmail.com
EMAIL_PASS=your-16-character-app-password
```

## הגדרה עבור ספקי מייל אחרים

### Outlook/Hotmail
```env
EMAIL_HOST=smtp-mail.outlook.com
EMAIL_PORT=587
EMAIL_USER=your-email@outlook.com
EMAIL_PASS=your-password
```

### Yahoo Mail
```env
EMAIL_HOST=smtp.mail.yahoo.com
EMAIL_PORT=587
EMAIL_USER=your-email@yahoo.com
EMAIL_PASS=your-app-password
```

### שרת SMTP מותאם אישית
```env
EMAIL_HOST=your-smtp-server.com
EMAIL_PORT=587  # או 465 עבור SSL
EMAIL_USER=your-username
EMAIL_PASS=your-password
```

## בדיקת התקנה

### 1. בדיקה דרך הממשק
1. עבור לדף "ניהול משתמשים" בפאנל הניהול
2. לחץ על כפתור "בדיקת מייל" (כחול)
3. הזן כתובת מייל לבדיקה
4. לחץ "שליחת מייל בדיקה"

### 2. בדיקה דרך API
```bash
curl -X POST http://localhost:3000/api/admin/test-email \
  -H "Content-Type: application/json" \
  -d '{"testEmail": "test@example.com"}'
```

## פתרון בעיות נפוצות

### שגיאת חיבור לשרת
- ודא שהגדרת את `EMAIL_HOST` ו-`EMAIL_PORT` נכון
- בדוק שאין חומת אש חוסמת את הפורט
- ודא שהשרת תומך ב-STARTTLS

### שגיאת אימות
- ודא שהגדרת `EMAIL_USER` ו-`EMAIL_PASS` נכון
- עבור Gmail, ודא שיצרת סיסמת אפליקציה
- בדוק שהחשבון לא נחסם

### המייל לא מגיע
- בדוק את תיקיית הספאם
- ודא שכתובת השולח לא ברשימה שחורה
- בדוק את לוגים בקונסול לשגיאות

### שגיאות תבנית
- ודא שהגדרת `NEXT_PUBLIC_SITE_URL` נכון
- בדוק שאין תווים מיוחדים בנתונים
- ודא שהקידוד UTF-8 פועל נכון

## התאמה אישית

### שינוי עיצוב המייל
ערוך את הקובץ `lib/services/emailService.ts` בפונקציה `generateWelcomeEmailHTML`.

### הוספת שדות נוספים
1. עדכן את ה-interface `WelcomeEmailData`
2. עדכן את הקריאות ב-API endpoints
3. עדכן את תבנית ה-HTML

### שינוי נושא המייל
ערוך את השורות עם `subject` בפונקציה `sendWelcomeEmail`.

## אבטחה

### הגנה על פרטי התחברות
- אל תשמור סיסמאות במאגר הנתונים
- השתמש במשתני סביבה בלבד
- ודא שקובץ `.env.local` לא נכלל ב-git

### הגבלת גישה
- רק מנהלי מערכת יכולים לשלוח מיילי בדיקה
- המערכת בודקת הרשאות לפני שליחה
- לוגים מתועדים לכל פעולה

## מעקב ולוגים

המערכת מתעדת:
- הצלחה/כישלון בשליחת מיילים
- שגיאות חיבור לשרת
- פרטי המיילים שנשלחו (ללא סיסמאות)

לוגים זמינים בקונסול השרת ובכלי הפיתוח של הדפדפן.

## תמיכה

במקרה של בעיות:
1. בדוק את הלוגים בקונסול
2. נסה את כלי בדיקת המייל המובנה
3. ודא שכל משתני הסביבה מוגדרים נכון
4. בדוק את הגדרות הספק שלך