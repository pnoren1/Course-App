# מדריך תיקון מערכת ההערות

## הבעיות הנפוצות
1. `Error adding comment: {}` - הודעות שגיאה לא ברורות
2. `null value in column "user_id"` - השדה user_id לא מוגדר כראוי
3. בעיות הרשאות RLS

## הפתרון

### שלב 1: הרצת המיגרציות החדשות
```bash
npx supabase db push
```

או אם אתה משתמש ב-Supabase CLI:
```bash
supabase migration up
```

**מיגרציות חדשות:**
- `043_fix_submission_comments_policies.sql` - תיקון מדיניות RLS
- `044_fix_submission_comments_user_id.sql` - תיקון ברירת מחדל ל-user_id
- `045_restore_student_comments_policy.sql` - החזרת מדיניות לתלמידים לראות הערות

### שלב 2: בדיקת מצב המערכת
ניתן לבדוק את מצב מערכת ההערות דרך:
- API endpoint: `/api/admin/check-comments-table`
- או דרך הקונסול של הדפדפן כשמנסים להוסיף הערה

### שלב 3: וידוא הרשאות משתמש
ודא שהמשתמש מוגדר עם תפקיד `admin` או `org_admin` בטבלת `user_profile`.

## מה השתנה?

### תיקון שדה user_id
- הקוד עכשיו מוסיף במפורש את ה-user_id של המשתמש המחובר
- המיגרציה מוסיפה ברירת מחדל `auth.uid()` לשדה

### מדיניות RLS מעודכנת
המיגרציה החדשה מעדכנת את מדיניות RLS כך ש:

1. **מנהלי מערכת (admin)** - יכולים לראות ולהוסיף הערות על כל ההגשות
2. **מנהלי ארגון (org_admin)** - יכולים לראות ולהוסיף הערות רק על הגשות של תלמידים מהארגון שלהם

### שיפורים בקומפוננט
- הודעות שגיאה ברורות יותר
- בדיקת הרשאות לפני הצגת טופס ההערות
- לוגים מפורטים יותר לאבחון בעיות
- בדיקת חיבור משתמש לפני הוספת הערה

### הצגת הערות בדף הקורס
- הערות מוצגות עכשיו גם בדף הקורס עצמו, לא רק בממשק הניהול
- תלמידים יכולים לראות הערות לא-פנימיות על ההגשות שלהם
- טופס הוספת הערות מוצג רק בממשק הניהול

## בדיקת תקינות
לאחר הרצת המיגרציות, ודא ש:
1. ניתן לראות הערות קיימות
2. ניתן להוסיף הערות חדשות
3. הודעות השגיאה ברורות במקרה של בעיה

## פתרון בעיות נפוצות

### "null value in column user_id"
- הרץ את המיגרציה החדשה: `044_fix_submission_comments_user_id.sql`
- ודא שהמשתמש מחובר למערכת

### "אין לך הרשאה להוסיף הערות"
- ודא שהמשתמש מוגדר כ-`admin` או `org_admin`
- בדוק שהמיגרציה הורצה בהצלחה

### "תכונת ההערות תהיה זמינה לאחר הרצת המיגרציות"
- הרץ את המיגרציות: `npx supabase db push`

### "יש להתחבר כדי להוסיף הערה"
- ודא שהמשתמש מחובר למערכת
- בדוק שה-session תקף

### השגיאה עדיין מתרחשת
- בדוק את הקונסול של הדפדפן לפרטים נוספים
- ודא שהמשתמש מחובר למערכת
- בדוק שה-submission_id תקין